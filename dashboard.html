<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ ¡å°ˆè»Šè·¯éšŠé•·ç®¡ç†ç³»çµ±ï½œDashboard</title>

<style>
:root{
  --primary:#0088FF;
  --primary-dark:#0077E6;
  --bg1:#eef2f7;
  --bg2:#e5eaf2;
  --text:#111827;
  --muted:#6b7280;
  --border:#eef2f7;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
}

body{
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  min-height:100vh;
  color:var(--text);
}

a{ color:inherit; text-decoration:none; }

/* ===== Layout ===== */
.app{
  width:min(1200px, calc(100% - 32px));
  margin:22px auto 26px;
  display:grid;
  grid-template-columns: 280px 1fr;
  gap:18px;
  align-items:stretch;
}

@media (max-width: 900px){
  .app{
    grid-template-columns: 1fr;
    width:calc(100% - 20px);
    margin:14px auto 18px;
  }
}

/* ===== Sidebar ===== */
.sidebar{
  background:white;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,0.08);
  padding:18px 16px;
  position:sticky;
  top:18px;
  height: calc(100vh - 36px);
  overflow:auto;
}

.brand{
  display:flex;
  gap:12px;
  align-items:center;
  padding:10px 10px 14px;
  border-bottom:1px solid var(--border);
  margin-bottom:12px;
}

.brand img{
  width:42px;
  height:42px;
  border-radius:12px;
  background:#f3f4f6;
}

.brand h1{
  font-size:16px;
  font-weight:800;
  color:#1f2937;
  line-height:1.2;
}

.brand p{
  font-size:11px;
  color:var(--muted);
  letter-spacing:2px;
  margin-top:3px;
}

.nav{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.navbtn{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  border-radius:14px;
  cursor:pointer;
  user-select:none;
  transition:all .15s ease;
  border:1px solid transparent;
}

.navbtn:hover{
  background:#f9fafb;
  border-color:var(--border);
}

.navbtn.active{
  background:var(--primary);
  color:white;
}

.icon{
  width:34px;
  height:34px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,136,255,0.12);
  color:var(--primary);
  font-weight:800;
}

.navbtn.active .icon{
  background:rgba(255,255,255,.22);
  color:white;
}

.navlabel{
  display:flex;
  flex-direction:column;
  gap:2px;
}

.navlabel b{ font-size:14px; }
.navlabel span{ font-size:12px; opacity:.9; }

.sidefoot{
  margin-top:16px;
  padding-top:14px;
  border-top:1px solid var(--border);
}

.small{
  font-size:12px;
  color:var(--muted);
  line-height:1.6;
}

.logout{
  margin-top:10px;
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:var(--primary);
  color:white;
  font-weight:800;
  cursor:pointer;
  transition:all .2s ease;
}
.logout:hover{ background:var(--primary-dark); }

/* ===== Main ===== */
.main{
  background:white;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,0.08);
  padding:18px 18px 22px;
  overflow:hidden;
}

.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  border-bottom:1px solid var(--border);
  padding-bottom:14px;
  margin-bottom:16px;
}

.leftTop{
  display:flex;
  align-items:flex-start;
  gap:10px;
}

.hamburger{
  display:none;
  width:44px;
  height:44px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#f9fafb;
  cursor:pointer;
  align-items:center;
  justify-content:center;
  transition:.15s ease;
}
.hamburger:hover{ border-color:#dbe5f5; background:#fff; }

.hamburger svg{
  width:22px;
  height:22px;
}

.pageTitle{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.pageTitle h2{
  font-size:18px;
  color:var(--text);
}

.pageTitle p{
  font-size:12px;
  color:var(--muted);
  letter-spacing:1px;
}

.userbox{
  display:flex;
  align-items:center;
  gap:10px;
  background:#f9fafb;
  border:1px solid var(--border);
  padding:10px 12px;
  border-radius:14px;
  min-width: 220px;
}

.userdot{
  width:10px;
  height:10px;
  border-radius:50%;
  background:#16a34a;
}

.userinfo{
  display:flex;
  flex-direction:column;
  gap:2px;
}

.userinfo b{
  font-size:13px;
  color:var(--text);
}
.userinfo span{
  font-size:12px;
  color:var(--muted);
}

/* Sections */
.section{
  display:none;
  animation: fadeUp .22s ease;
}
.section.active{ display:block; }

@keyframes fadeUp{
  from{ opacity:0; transform:translateY(8px); }
  to{ opacity:1; transform:translateY(0); }
}

.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
}
@media (max-width: 900px){
  .grid{ grid-template-columns: 1fr; }
}

.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
}
.card h3{
  font-size:15px;
  margin-bottom:8px;
  color:var(--text);
}
.card p{
  font-size:12px;
  color:var(--muted);
  line-height:1.7;
}

.notice{
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
  line-height:1.6;
}

/* ===== Loading overlay ===== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(238,242,247,.75);
  backdrop-filter: blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.loader{
  width:min(420px, calc(100% - 40px));
  background:white;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,0.12);
  padding:18px 18px 16px;
  border:1px solid var(--border);
}
.loader h3{ font-size:16px; color:var(--text); }
.loader p{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
  line-height:1.6;
}
.barWrap{
  margin-top:12px;
  height:10px;
  background:var(--border);
  border-radius:999px;
  overflow:hidden;
}
.bar{
  height:10px;
  width:0%;
  background:var(--primary);
  border-radius:999px;
  transition:width .22s ease;
}

/* ===== Mobile drawer behavior ===== */
.drawerBackdrop{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(17,24,39,.38);
  z-index:998;
}

@media (max-width: 900px){
  .hamburger{ display:flex; }

  /* Sidebar becomes drawer */
  .sidebar{
    position:fixed;
    top:0;
    left:0;
    height:100vh;
    width: 86vw;
    max-width: 320px;
    border-radius:0 18px 18px 0;
    transform:translateX(-102%);
    transition:transform .22s ease;
    z-index:999;
    box-shadow: 0 20px 60px rgba(0,0,0,.25);
  }
  .sidebar.open{
    transform:translateX(0);
  }
  .drawerBackdrop.show{
    display:block;
  }
}
</style>
</head>

<body>

<!-- Loading Overlay -->
<div class="overlay" id="overlay">
  <div class="loader">
    <h3 id="loadTitle">è¼‰å…¥ä¸­â€¦</h3>
    <p id="loadText">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±</p>
    <div class="barWrap"><div class="bar" id="loadBar"></div></div>
  </div>
</div>

<!-- Mobile drawer backdrop -->
<div class="drawerBackdrop" id="drawerBackdrop"></div>

<div class="app" id="app" style="display:none;">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <img src="./schoolbadge.gif" alt="æ ¡å¾½">
      <div>
        <h1>æ ¡å°ˆè»Šè·¯éšŠé•·ç®¡ç†ç³»çµ±</h1>
        <p>TEAMLEADER SYSTEM</p>
      </div>
    </div>

    <nav class="nav" id="nav">
      <div class="navbtn active" data-target="home">
        <div class="icon">ğŸ </div>
        <div class="navlabel">
          <b>ç¸½è¦½</b>
          <span>æœ¬å­¸æœŸç‹€æ…‹èˆ‡æé†’</span>
        </div>
      </div>

      <div class="navbtn" data-target="import">
        <div class="icon">â¬†ï¸</div>
        <div class="navlabel">
          <b>åŒ¯å…¥ä¸­å¿ƒ</b>
          <span>å­¸ç”Ÿ/è»Šè¡¨/åå–®</span>
        </div>
      </div>

      <div class="navbtn" data-target="violation">
        <div class="icon">ğŸ“</div>
        <div class="navlabel">
          <b>é•è¦ç™»è¨˜</b>
          <span>ç™»è¨˜èˆ‡å½™æ•´</span>
        </div>
      </div>

      <div class="navbtn" data-target="query">
        <div class="icon">ğŸ”</div>
        <div class="navlabel">
          <b>æŸ¥è©¢</b>
          <span>å­¸ç”Ÿ/è»Šé•·è³‡æ–™</span>
        </div>
      </div>

      <div class="navbtn" data-target="audit">
        <div class="icon">ğŸ§¾</div>
        <div class="navlabel">
          <b>æ“ä½œç´€éŒ„</b>
          <span>ä¾æ™‚é–“åºæœå°‹</span>
        </div>
      </div>

      <div class="navbtn" data-target="settings">
        <div class="icon">âš™ï¸</div>
        <div class="navlabel">
          <b>ç³»çµ±è¨­å®š</b>
          <span>å­¸æœŸ/æ¬Šé™/å°å­˜</span>
        </div>
      </div>
    </nav>

    <div class="sidefoot">
      <div class="small" id="semesterHint">å­¸æœŸï¼šè®€å–ä¸­â€¦</div>
      <button class="logout" id="btnLogout">ç™»å‡º</button>
      <div class="small" style="margin-top:10px;color:#9ca3af;">Â© TeamLeader</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="leftTop">
        <!-- Mobile hamburger -->
        <button class="hamburger" id="btnHamburger" aria-label="é–‹å•Ÿé¸å–®">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 6h16"></path>
            <path d="M4 12h16"></path>
            <path d="M4 18h16"></path>
          </svg>
        </button>

        <div class="pageTitle">
          <h2 id="pageTitle">ç¸½è¦½</h2>
          <p id="pageSub">æœ¬å­¸æœŸç‹€æ…‹èˆ‡æé†’</p>
        </div>
      </div>

      <div class="userbox">
        <div class="userdot"></div>
        <div class="userinfo">
          <b id="userLine1">è®€å–ä¸­â€¦</b>
          <span id="userLine2">â€”</span>
        </div>
      </div>
    </div>

    <section class="section active" id="sec-home">
      <div class="grid">
        <div class="card">
          <h3>æœ¬å­¸æœŸè³‡æ–™ç‹€æ…‹</h3>
          <p id="homeStatus">æ­£åœ¨è®€å–â€¦</p>
          <div class="notice" id="homeNotice"></div>
        </div>
        <div class="card">
          <h3>å¿«é€Ÿæé†’</h3>
          <p>å¾ŒçºŒæœƒæŠŠã€ŒåŒ¯å…¥ç‰ˆæœ¬æ™‚é–“ã€ã€ã€Œåå–®ç¼ºæ¼è­¦å‘Šã€ã€ã€Œåœé§›æé†’ã€æ”¾åœ¨é€™è£¡ã€‚</p>
        </div>
      </div>
    </section>

    <section class="section" id="sec-import">
      <div class="card">
        <h3>åŒ¯å…¥ä¸­å¿ƒ</h3>
        <p>ä¸‹ä¸€æ­¥æœƒå…ˆåšã€ŒåŒ¯å…¥å­¸ç”Ÿåå–®ã€èˆ‡ã€ŒåŒ¯å…¥è»Šè¡¨ã€ã€‚ç›®å‰å…ˆæŠŠå…¥å£åšå‡ºä¾†ã€‚</p>
      </div>
    </section>

    <section class="section" id="sec-violation">
      <div class="card">
        <h3>é•è¦ç™»è¨˜</h3>
        <p>ä¸‹ä¸€æ­¥æœƒåšï¼šå–®ä¸€è¼¸å…¥æ¬„ä½ï¼ˆå­¸è™Ÿ/ç­åº§/æ¨¡ç³ŠæŸ¥ï¼‰ï¼‹é•è¦äº‹ä»¶å»ºç«‹ï¼‹åˆ—å°é€šçŸ¥å–®æµç¨‹ã€‚</p>
      </div>
    </section>

    <section class="section" id="sec-query">
      <div class="card">
        <h3>æŸ¥è©¢</h3>
        <p>ä¹‹å¾Œä¾èº«ä»½é¡¯ç¤ºä¸åŒæ¬„ä½ï¼ˆå­¸ç”Ÿåªèƒ½çœ‹è‡ªå·±ï¼›å¹¹éƒ¨/è¡Œæ”¿å¯æŸ¥å…¨éƒ¨ï¼‰ã€‚</p>
      </div>
    </section>

    <section class="section" id="sec-audit">
      <div class="card">
        <h3>æ“ä½œç´€éŒ„</h3>
        <p>æ‰€æœ‰æ“ä½œæŒ‰æ™‚é–“åºæ··åœ¨ä¸€èµ·ï¼Œå¯æœå°‹ã€Œèª°åšäº†ä»€éº¼äº‹ã€ã€‚</p>
      </div>
    </section>

    <section class="section" id="sec-settings">
      <div class="card">
        <h3>ç³»çµ±è¨­å®š</h3>
        <p>è¶…ç´šç®¡ç†å“¡ç™¼æ”¾æ¬Šé™ã€å­¸æœŸå°å­˜/åˆ‡æ›ã€å°å­˜è³‡æ–™å€æŸ¥è©¢ã€‚</p>
      </div>
    </section>

  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
/* ===== Firebase init ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAXgHiQ-Kh6cv4kkOFuHVCUOwD-C1HoUQI",
  authDomain: "teamleader-system.firebaseapp.com",
  projectId: "teamleader-system",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* ===== UI refs ===== */
const overlay = document.getElementById("overlay");
const loadTitle = document.getElementById("loadTitle");
const loadText  = document.getElementById("loadText");
const loadBar   = document.getElementById("loadBar");
const app       = document.getElementById("app");

const semesterHint = document.getElementById("semesterHint");

const userLine1 = document.getElementById("userLine1");
const userLine2 = document.getElementById("userLine2");

const homeStatus = document.getElementById("homeStatus");
const homeNotice = document.getElementById("homeNotice");

/* mobile drawer */
const sidebar = document.getElementById("sidebar");
const backdrop = document.getElementById("drawerBackdrop");
const btnHamburger = document.getElementById("btnHamburger");

/* ===== Helpers ===== */
function setOverlay(t1, t2, p){
  loadTitle.textContent = t1;
  loadText.textContent  = t2;
  loadBar.style.width   = (p || 0) + "%";
}

function showApp(){
  app.style.display = "grid";
  overlay.style.display = "none";
}

/* ===== Drawer open/close ===== */
function openDrawer(){
  sidebar.classList.add("open");
  backdrop.classList.add("show");
}
function closeDrawer(){
  sidebar.classList.remove("open");
  backdrop.classList.remove("show");
}
btnHamburger.addEventListener("click", openDrawer);
backdrop.addEventListener("click", closeDrawer);

/* ===== Navigation ===== */
function activate(target){
  document.querySelectorAll(".navbtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.target === target);
  });
  document.querySelectorAll(".section").forEach(s=>{
    s.classList.toggle("active", s.id === "sec-" + target);
  });

  const map = {
    home: ["ç¸½è¦½","æœ¬å­¸æœŸç‹€æ…‹èˆ‡æé†’"],
    import: ["åŒ¯å…¥ä¸­å¿ƒ","å­¸ç”Ÿ/è»Šè¡¨/åå–®"],
    violation: ["é•è¦ç™»è¨˜","ç™»è¨˜èˆ‡å½™æ•´"],
    query: ["æŸ¥è©¢","å­¸ç”Ÿ/è»Šé•·è³‡æ–™"],
    audit: ["æ“ä½œç´€éŒ„","ä¾æ™‚é–“åºæœå°‹"],
    settings: ["ç³»çµ±è¨­å®š","å­¸æœŸ/æ¬Šé™/å°å­˜"],
  };
  document.getElementById("pageTitle").textContent = map[target][0];
  document.getElementById("pageSub").textContent   = map[target][1];

  // æ‰‹æ©Ÿé»é¸å¾Œè‡ªå‹•æ”¶èµ·ï¼Œé¿å…è¤‡é›œ
  closeDrawer();
}

document.getElementById("nav").addEventListener("click", (e)=>{
  const btn = e.target.closest(".navbtn");
  if(!btn) return;
  activate(btn.dataset.target);
});

/* ===== Logout ===== */
document.getElementById("btnLogout").onclick = async ()=>{
  await auth.signOut();
  window.location.href = "index.html";
};

/* ===== Auth gate + load profile + semester ===== */
auth.onAuthStateChanged(async (user)=>{
  if(!user){
    window.location.href = "index.html";
    return;
  }

  overlay.style.display = "flex";
  setOverlay("è¼‰å…¥ä¸­â€¦","æ­£åœ¨é©—è­‰ç™»å…¥ç‹€æ…‹", 18);

  // è®€å–å­¸æœŸ
  setOverlay("è¼‰å…¥ä¸­â€¦","æ­£åœ¨è®€å–å­¸æœŸè³‡æ–™", 42);
  let semesterId = "";
  try{
    const settingsDoc = await db.collection("settings").doc("global").get();
    semesterId = String(settingsDoc.get("active_semester_id") || "");
  }catch(e){
    semesterId = "";
  }
  semesterHint.textContent = "å­¸æœŸï¼š" + (semesterId || "æœªè¨­å®š");

  // è®€å–ä½¿ç”¨è€…è³‡æ–™ï¼ˆè·ç¨±+å§“å+enabledï¼‰
  setOverlay("è¼‰å…¥ä¸­â€¦","æ­£åœ¨è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™", 72);
  const uDoc = await db.collection("users").doc(user.uid).get();
  const u = uDoc.exists ? uDoc.data() : null;

  // æœªé–‹é€š â†’ å¼·åˆ¶ç™»å‡ºï¼ˆé¿å…ç¹éï¼‰
  if(!u || u.enabled !== true){
    await auth.signOut();
    window.location.href = "index.html";
    return;
  }

  const title = u.title || "æœªè¨­å®šè·ç¨±";
  const name  = u.name  || "";
  userLine1.textContent = `${title}ï½œ${name || (user.email || "")}`;
  userLine2.textContent = user.email || "";

  setOverlay("æº–å‚™å®Œæˆ","æ­£åœ¨é€²å…¥ç³»çµ±", 92);

  homeStatus.textContent = "å·²ç™»å…¥ï¼Œå¯é–‹å§‹æ“ä½œã€‚";
  homeNotice.textContent = "æç¤ºï¼šå­¸ç”Ÿç«¯è³‡æ–™å°‡é¡¯ç¤ºã€Œä¾ç¸½å‹™è™•ç‚ºæº–ã€æé†’ã€‚";

  setTimeout(showApp, 220);
});
</script>

</body>
</html>